services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: coderunner-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-code_runner_db}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      TZ: ${DB_TIMEZONE:-UTC}
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-code_runner_db}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - coderunner-network

  # pgAdmin - Database Management UI
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: coderunner-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@coderunner.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - coderunner-network

  # CodeRunner gRPC Microservice with Docker-in-Docker
  coderunner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coderunner-service
    restart: unless-stopped
    privileged: true
    environment:
      # Application Configuration
      APP_NAME: ${APP_NAME:-microservice-code-runner}
      API_VERSION: ${API_VERSION:-v1}
      PORT: ${PORT:-8084}
      GRPC_PORT: ${GRPC_PORT:-9084}

      # Database Configuration (PostgreSQL)
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_NAME: ${DB_NAME:-code_runner_db}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      DB_TIMEZONE: ${DB_TIMEZONE:-UTC}

      # Database Connection Pool
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-10}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-3600}

      # Kafka / Azure Event Hub Configuration
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      KAFKA_CONNECTION_STRING: ${KAFKA_CONNECTION_STRING}
      KAFKA_TOPIC: ${KAFKA_TOPIC:-challenge.completed}
      KAFKA_CONSUMER_GROUP: ${KAFKA_CONSUMER_GROUP:-code-runner-service}
      KAFKA_SASL_MECHANISM: ${KAFKA_SASL_MECHANISM:-PLAIN}
      KAFKA_SECURITY_PROTOCOL: ${KAFKA_SECURITY_PROTOCOL:-SASL_SSL}
      KAFKA_PRODUCER_TIMEOUT_MS: ${KAFKA_PRODUCER_TIMEOUT_MS:-30000}
      KAFKA_CONSUMER_TIMEOUT_MS: ${KAFKA_CONSUMER_TIMEOUT_MS:-30000}
      KAFKA_MAX_RETRIES: ${KAFKA_MAX_RETRIES:-3}

      # Service Discovery (Eureka)
      SERVICE_DISCOVERY_URL: ${SERVICE_DISCOVERY_URL}
      SERVICE_DISCOVERY_ENABLED: ${SERVICE_DISCOVERY_ENABLED:-false}
      SERVICE_PUBLIC_IP: ${SERVICE_PUBLIC_IP}
      SERVICE_NAME: ${SERVICE_NAME:-CODE-RUNNER-SERVICE}

      # Logging Configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}

      # Docker Configuration
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_TLS_CERTDIR: ""

    ports:
      - "${GRPC_PORT:-9084}:9084"
      - "${PORT:-8084}:8084"
    volumes:
      # Docker-in-Docker socket (using tmpfs for better security)
      - dind-storage:/var/lib/docker
      - ./logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - coderunner-network
    dns:
      - 8.8.8.8
      - 8.8.4.4

  # Optional: Service Discovery (Eureka Server)
  # Uncomment if you want to run your own Eureka server
  # eureka:
  #   image: steeltoeoss/eureka-server:latest
  #   container_name: coderunner-eureka
  #   restart: unless-stopped
  #   ports:
  #     - "8761:8761"
  #   environment:
  #     EUREKA_INSTANCE_HOSTNAME: eureka
  #     EUREKA_CLIENT_REGISTERWITEUREKA: "false"
  #     EUREKA_CLIENT_FETCHREGISTRY: "false"
  #   networks:
  #     - coderunner-network

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  dind-storage:
    driver: local

networks:
  coderunner-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
